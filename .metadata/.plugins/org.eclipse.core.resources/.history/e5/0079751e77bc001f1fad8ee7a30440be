<?xml version="1.0" encoding="UTF-8"?>
<api context="/application/maxim/v1/order-details" name="MaximNBNOrderDetailInboundService" xmlns="http://ws.apache.org/ns/synapse">
    <resource methods="GET">
        <inSequence>
            <log level="custom">
                <property name="Flow" value="Request received in Pre-Proxy Flow"/>
            </log>
            <!-- Additional Pre-Proxy Policies -->
            <!--  Logging Request Details -->
            <log level="custom">
                <property expression="get-property('REST_FULL_REQUEST_PATH')" name="RequestURI"/>
                <property expression="get-property('axis2', 'HTTP_METHOD')" name="HTTPMethod"/>
                <property expression="get-property('transport', 'Authorization')" name="Authorization"/>
            </log>
            <!--  Spike Arrest -->
            <throttle id="Spike-Arrest">
                <onReject>
                    <log level="custom">
                        <property name="Error" value="Spike Arrest Triggered"/>
                    </log>
                    <drop/>
                </onReject>
                <onAccept/>
            </throttle>
            <!-- Verify Access Token -->
            <call>
                <endpoint>
                    <http method="post" uri-template="https://oauth-server-url/introspect">
                        <suspendOnFailure>
                            <initialDuration>2000</initialDuration>
                            <progressionFactor>1.5</progressionFactor>
                            <maximumDuration>30000</maximumDuration>
                        </suspendOnFailure>
                        <markForSuspension>
                            <retriesBeforeSuspension>3</retriesBeforeSuspension>
                        </markForSuspension>
                    </http>
                </endpoint>
            </call>
            <!-- Extract Session Token and Headers -->
            <property expression="json-eval($.sessionToken)" name="SessionToken" scope="default" type="STRING"/>
            <property expression="get-property('trsnsport', 'Content-Type')" name="Content-Type" scope="default" type="STRING"/>
            <log level="custom">
                <property expression="get-property('SessionToken')" name="SessionToken"/>
            </log>
            <!--  Key-Value Map Operations -->
            <property expression="fn:lookup('conf:/kvm/global-config', 'quota')" name="QuotaLimit" scope="default" type="STRING"/>
            <log level="custom">
                <property expression="get-property('QuotaLimit')" name="Quota"/>
            </log>
            <!-- Cache Lookup  -->
            <cache collector="false" maxMessageSize="5000" timeout="300">
                <onCacheHit>
                    <log level="custom">
                        <property name="Cache" value="Cache Hit - Returning Cached Response"/>
                    </log>
                    <send/>
                </onCacheHit>
                <protocol type="HTTP">
                    <methods>*</methods>
                    <headersToExcludeInHash/>
                    <headersToIncludeInHash/>
                    <responseCodes>.*</responseCodes>
                    <enableCacheControl>false</enableCacheControl>
                    <includeAgeHeader>false</includeAgeHeader>
                    <hashGenerator>org.wso2.carbon.mediator.cache.digest.HttpRequestHashGenerator</hashGenerator>
                </protocol>
                <implementation maxSize="1000"/>
            </cache>
            <cache collector="true" scope="per-host"/>
            <!-- Assign Default Error Response -->
        </inSequence>
        <outSequence>
            <log level="custom">
                <property name="Flow" value="Response sent from Post-Proxy Flow"/>
            </log>
            <!-- Additional Post-Proxy Policies -->
        </outSequence>
        <faultSequence>
            <log level="custom">
                <property name="Error" value="Error occurred in API execution"/>
            </log>
            <send/>
        </faultSequence>
    </resource>
</api>
